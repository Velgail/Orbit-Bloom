# Orbit Bloom 技術仕様・実装指示書（ドラフト）

このドキュメントは、Orbit Bloom を HTML5 Canvas + 純粋な JavaScript (ES6) で実装するための仕様書です。  
Claude Code 等のコード生成ツールに、「この仕様書に従って実装して」と指示することを前提としています。

---

## 0. 目標

- 初心者でも「動かす・避ける・当てる」がすぐ理解できる、やさしめ縦スクロール風サバイバルシューティング。
- グラフィックはすべて Canvas の図形描画のみで構成。
- パラメータ表をいじるだけで難易度調整ができるコード構造。

---

## 1. 技術仕様

### 1.1 使用技術・制約

- HTML5 `<canvas>` 2D コンテキストのみ使用
- 純粋な JavaScript（ES6 相当）
- 外部ライブラリ・フレームワークは使用しない
- ホスティング想定: GitHub Pages（静的サイト）

### 1.2 ファイル構成

リポジトリ直下:

- `index.html`
- `style.css`
- `main.js`
- （任意）`docs/spec-orbit-bloom.md` ← このファイル

### 1.3 ゲームループ

- `requestAnimationFrame` によるメインループ
- `timestamp` から `deltaTime`（秒）を計算し、フレームレート差を吸収
- `dt` が異常に大きい場合（例: 0.05 秒以上）はクランプする

---

## 2. 画面・座標系・描画ルール

### 2.1 座標系

- ゲーム内論理座標:
  - 幅 `GAME_WIDTH = 360`
  - 高さ `GAME_HEIGHT = 640`
- Canvas は常に `window.innerWidth × window.innerHeight` にフィット
- 実画面への描画は
  - `scale = min(windowWidth / GAME_WIDTH, windowHeight / GAME_HEIGHT)`
  - 中央寄せのための `offsetX`, `offsetY` を計算して `translate + scale`

### 2.2 カラー・ビジュアル

- 背景
  - 濃紺〜黒のグラデーション（CSS 側の背景 + Canvas 側での単色塗りで OK）
- 自機
  - 明るいシアン系（例: `#40E0FF`）
- 敵
  - 複数の固定色から選択（例: 黄色 `#FFD95A` / マゼンタ `#FF5AF2` / ライムグリーン `#7CFF5A`）
- 弾
  - 自機弾: 明るいシアン系
  - 敵弾: 目立つ暖色系（例: オレンジ〜赤）

### 2.3 描画ルール

- すべて Canvas 図形描画 API による:
  - `fillRect`, `beginPath`, `arc`, `lineTo`, `stroke`, `fill` 等のみ
- グラフィックリソース画像は使わない
- パーティクル表現
  - 自機移動時のテール（速度に応じて小さな点／線を出す）
  - 敵撃破時の破片パーティクル
  - 背景の常時点滅する星（緩やかにフェードイン・アウト）

---

## 3. UI・画面レイアウト

### 3.1 表示要素

- 左上: スコア
- 右上: 残ライフ（数字で OK）
- 上中央: 残り時間（秒）
- 画面中央オーバーレイ:
  - タイトル／待機時: 「クリック / タップでスタート」
  - ゲームオーバー時: 「Game Over」＋「クリック / タップでリトライ」
  - 将来的にステージクリア表示もここに出す

### 3.2 UI 実装

- UI は HTML オーバーレイ要素で実装（`position: fixed`）
- Canvas は常に背面で全画面表示

---

## 4. ゲームルール仕様

### 4.1 基本サイクル

- 形式: 時間制サバイバル + ステージ制
- 1 ステージの基本:
  - デフォルト: 60 秒
  - ステージごとに `stageConfigs` で変更可能
- クリア条件:
  - 指定時間を生存すること（v1 では時間切れでステージクリア扱いにしてもよい）
- ゲームオーバー条件:
  - ライフが 0 になる

### 4.2 プレイヤー仕様

#### 4.2.1 形状

- 中心円 + 下側に翼三角形 1つ（簡易ポリゴン）
- 当たり判定は円で扱う
  - 描画半径: `10px`
  - 判定半径: `6px`（パラメータ化）

#### 4.2.2 ライフ・無敵

- 初期ライフ: `3`
- 被弾時:
  - ライフ `-1`
  - 一定時間「無敵状態」に入る
- 無敵時間:
  - 初期値: `1.0` 秒（パラメータ化）
- 無敵中の表現:
  - 自機の透明度を周期的に変える・点滅させるなど

#### 4.2.3 移動

- 慣性なし。入力に応じて即座に速度決定
- PC:
  - 移動: `WASD` または 矢印キー
- スピード:
  - 基本移動速度 `playerSpeed = 200 px/s`（パラメータ化）
- 画面外に出ないよう、座標をクリップ

#### 4.2.4 攻撃（ショット）

- 自動連射の前方ショットのみ
- 弾:
  - 形状: 小さい円
  - 速度: 上方向へ一定速度（例: `-300 px/s`）
- 連射間隔:
  - 初期値: `0.2 秒`（パラメータ化）
- プレイヤーは主に「避け」と「位置取り」に集中できる設計

### 4.3 ダッシュ（特殊アクション）

#### 4.3.1 共通仕様

- 発動時:
  - 移動速度が一定時間だけ倍率アップ
  - 自機は無敵状態になる（敵・弾の当たり判定を無視）
- 初期値（パラメータ化前提）:
  - ダッシュ速度倍率: `2.5`
  - ダッシュ継続時間: `0.2 秒`
  - クールダウン: `2.0 秒`
- ダッシュ中の見た目:
  - 自機の色を明るくする
  - 若干スケールアップさせる、あるいは尾を長くする

#### 4.3.2 PC での操作

- ダッシュキー:
  - `Shift` または `Space` キー
- ダッシュ方向:
  - 現在の移動入力ベクトル（WASD／矢印キー）をもとにする
  - 入力ベクトルが 0 のときは、直前の移動方向 or 上方向固定で良い

#### 4.3.3 モバイルでの操作（v1案）

- 移動:
  - 画面どこでもドラッグで自機の位置を追従
- ダッシュ:
  - 「フリック方向にダッシュ」案を採用
    - 一定時間・一定距離以上の素早いスワイプをフリックと判定
    - その方向にダッシュベクトルを決定
  - 実装簡略案として、v1 では以下でもよい:
    - ダッシュ専用ボタンを画面右下に配置し、「押した瞬間の drag 方向」にダッシュ
- PC 版のほうが難しくなり過ぎないよう、最終的には
  - PC: 移動入力方向にダッシュ
  - モバイル: フリック方向にダッシュ
  という対応関係で方向指定を揃える。

### 4.4 敵仕様

#### 4.4.1 共通

- 全て図形ベース（円・菱形・三角形）
- 各敵は以下の共通プロパティを持つ:
  - `x, y` 位置
  - `vx, vy` 速度
  - `radius`（当たり判定用の円）
  - `hp`
  - `type`（"basic" / "zigzag" / "homing" / "shooter" 等）
- 画面外に一定距離出たら削除

#### 4.4.2 敵タイプ

1. ベーシック敵 `"basic"`
   - 形状: 小さな丸
   - 挙動: 上から下への直進（`vy > 0` 固定）
2. ジグザグ敵 `"zigzag"`
   - 形状: 菱形
   - 挙動:
     - 下方向に落下しつつ、x 方向に正弦波 or 三角波的な揺れ
3. 追尾気味敵 `"homing"`
   - 形状: 三角形
   - 挙動:
     - 一定間隔（例: 0.2〜0.3 秒ごと）で、プレイヤー方向への角度を少し補正する
     - 毎フレーム完全追尾はしない（弱追尾）
4. 弾を撃つ敵 `"shooter"`
   - 形状: 少し大きい円
   - 挙動:
     - 下方向へゆっくり移動
     - 一定間隔（例: 1.0〜1.5 秒）でプレイヤー方向に敵弾を 1 発発射

### 4.5 敵弾仕様

- 形状: 小さな円
- 速度: `bulletSpeed` をステージ設定から参照
- 当たり判定: 円形
- プレイヤーと衝突したら被弾判定

---

## 5. ステージ・難易度設計

### 5.1 ステージ構成データ

- ステージごとに設定オブジェクトを持つ:

```js
const stageConfigs = [
  {
    duration: 60,
    phases: [
      {
        startTime: 0,
        endTime: 10,
        spawnRate: 0.5, // 1秒あたりの平均スポーン試行回数
        maxEnemies: 10,
        allowedTypes: ["basic"],
        enemySpeedMultiplier: 1.0,
        bulletSpeed: 160,
      },
      {
        startTime: 10,
        endTime: 30,
        spawnRate: 0.8,
        maxEnemies: 15,
        allowedTypes: ["basic", "zigzag"],
        enemySpeedMultiplier: 1.1,
        bulletSpeed: 180,
      },
      {
        startTime: 30,
        endTime: 60,
        spawnRate: 1.0,
        maxEnemies: 20,
        allowedTypes: ["basic", "zigzag", "shooter"],
        enemySpeedMultiplier: 1.2,
        bulletSpeed: 200,
      },
    ],
  },
  // stage 2, 3...
];
````

* 難易度調整は基本的にこの表を書き換えることで行う。

### 5.2 敵スポーンロジック

* `spawnAccumulator` を持ち、`dt` ごとに `spawnAccumulator += spawnRate * dt`
* `spawnAccumulator >= 1` になった回数だけ敵生成を試みる
* 現在の敵数が `maxEnemies` を超える場合はスポーンしない
* 出現位置:

  * x: 画面上端のランダム位置
  * y: 画面外少し上（例: `-20`）

---

## 6. 入力仕様詳細

### 6.1 PC キーボード

* 移動

  * `W / A / S / D` または 矢印キー
* ダッシュ

  * `Shift` または `Space`
* 同時押しはベクトル合成して正規化

### 6.2 モバイルタッチ

* タップ / ドラッグ:

  * 指一本のドラッグでプレイヤー位置を追従
  * 追従速度は補間（例: 0.2〜0.3 の追従率）で滑らかに
* ダッシュ（v1 実装案）

  * フリック: 一定時間内に一定距離以上動いたタッチをフリックと判定
  * フリック検出時にダッシュ発動
* タップでゲーム開始／リトライ

---

## 7. コード構成方針

### 7.1 モジュール関数（`main.js` 内）

* `init()` 初期化（リスナー設定、リサイズ処理など）
* `startGame()` ゲーム開始／リスタート
* `update(dt)` ゲーム状態更新
* `render(ctx)` 描画
* `spawnEnemies(dt)` 敵生成管理
* `updateEnemies(dt)` 敵更新
* `updateBullets(dt)` 弾更新
* `checkCollisions()` 衝突判定
* `handleInput()` 必要なら入力更新整理

### 7.2 クラス例

* `class Player`
* `class Enemy`
* `class Bullet`

  * `Bullet` はプレイヤー弾・敵弾の両方を扱ってもよい（`isPlayer` フラグなど）
* `class Particle`
* `class Star`（背景の星パーティクル）
* `GameState` オブジェクト

  * `state`（"title" | "playing" | "gameover"）
  * `score`
  * `timeLeft`
  * `lives`
  * `stageIndex`
  * `enemies`, `bullets`, `particles`

---

## 8. 調整用パラメータ（サマリ）

実装時には、以下のような定数オブジェクトにまとめておくと調整しやすい。

```js
const PLAYER_PARAMS = {
  moveSpeed: 200,
  radius: 10,
  hitRadius: 6,
  shotInterval: 0.2,
  dashSpeedMultiplier: 2.5,
  dashDuration: 0.2,
  dashCooldown: 2.0,
  invincibleDurationOnHit: 1.0,
  initialLives: 3,
};

const ENEMY_PARAMS = {
  basic: { speedY: 80, hp: 1, score: 10 },
  zigzag: { speedY: 90, ampX: 30, freq: 2, hp: 1, score: 15 },
  homing: { speed: 100, turnInterval: 0.25, turnAngle: 0.2, hp: 2, score: 25 },
  shooter: { speedY: 60, shotInterval: 1.2, hp: 3, score: 30 },
};

const BULLET_PARAMS = {
  player: { speedY: -300, radius: 3 },
  enemy: { radius: 3 },
};
```

---

## 9. オーディオについて（v1 方針）

* v1 実装では、オーディオはオフ／未実装で構わない
* 将来的に追加する場合の候補:

  * ショット SE（短いクリック音）
  * 敵撃破 SE
  * 被弾 SE
  * BGM（1 曲ループ）
* 実装時には `AudioContext` や `<audio>` タグなどを別モジュールに切り出す

---

## 10. Claude Code への指示例

このファイルを同じリポジトリに置いたうえで、Claude Code には以下のように指示することを想定:

> `docs/spec-orbit-bloom.md` の仕様に従って、
> `index.html`, `style.css`, `main.js` を実装してください。
> 既に存在するファイルがあれば内容を確認し、必要に応じてリファクタリングや追記を行ってください。
> パラメータは定数オブジェクトとして定義し、あとから値を変更しやすい形にしてください。
